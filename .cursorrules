# CONTEXTO DEL PROYECTO - PANEL ADMINISTRATIVO TELEGAN

## Descripci√≥n General
Panel de control est√°tico (HTML/CSS/JS) para administrar (CRUD completo) base de datos PostgreSQL de agricultores.
Se desplegar√° en hosting convencional con Apache y PHP.

## Arquitectura
- **Frontend**: Est√°tico (HTML/CSS/JS puro) - Mobile-first
- **Backend**: PHP 8.1+ PHP 8.1+ PURO (SIN frameworks, sin Slim, sin Laravel)
- **Base de datos**: PostgreSQL 14 (ya existe, NO crear tablas, solo cadena de conexion)
- **Servidor**: Apache en hosting convencional
- **ORM**: PDO nativo de PHP para PostgreSQL
- **Sin build tools**: Todo debe funcionar directo sin compilaci√≥n

## ESQUEMA DE BASE DE DATOS EXISTENTE
esta descrito muy especificamente en @database-schema.sql
### Tablas Principales (NO CREAR, SOLO CONSULTAR)

**usuario**
- id_usuario (SERIAL PRIMARY KEY)
- nombre_completo, email, telefono, password_hash
- ubicacion_general
- activo, email_verificado, telefono_verificado
- fecha_registro, ultima_sesion
- codigo_telegan

**demografia_usuario**
- id_demografia (SERIAL PRIMARY KEY)
- id_usuario (FK a usuario)
- genero, edad, grupo_etnico
- fecha_actualizacion

**pais**
- id_pais (SERIAL PRIMARY KEY)
- codigo_iso2, codigo_iso3, nombre_pais
- activo

**finca**
- id_finca (SERIAL PRIMARY KEY)
- nombre_finca, id_usuario_creador (FK), id_pais (FK)
- descripcion
- geometria_wkt (TEXT), geometria_postgis (GEOMETRY)
- area_hectareas
- estado, fecha_creacion, fecha_actualizacion
- codigo_telegan

**usuario_finca** (relaci√≥n muchos a muchos)
- id_usuario_finca (PK)
- id_usuario (FK), id_finca (FK)
- rol (ADMIN, COLABORADOR)
- fecha_asociacion

**potrero**
- id_potrero (SERIAL PRIMARY KEY)
- id_finca (FK)
- nombre_potrero, descripcion
- geometria_wkt, geometria_postgis
- area_hectareas, estado
- fecha_creacion, codigo_telegan

**registro_ganadero**
- id_registro (SERIAL PRIMARY KEY)
- id_potrero (FK), id_usuario (FK)
- fecha_registro, numero_animales
- tipo_pasto, estado_pasto, disponibilidad_agua
- ubicacion_agua_wkt, ubicacion_agua_postgis
- notas

**historial_cambios** (auditor√≠a)
- id_historial (PK)
- tabla_afectada, id_registro_afectado
- id_usuario (FK), tipo_accion
- datos_anteriores (JSONB), datos_nuevos (JSONB)
- fecha_accion

### Vistas Disponibles
- v_usuarios_fincas
- v_fincas_resumen
- v_dashboard_alertas

## Funcionalidades CRUD Requeridas

### 1. USUARIOS
- Listar con paginaci√≥n y b√∫squeda
- Ver detalle individual
- Crear nuevo usuario
- Editar usuario existente
- Activar/Desactivar (NO eliminar f√≠sicamente)
- Filtros: activo/inactivo, con/sin finca, por pa√≠s
- Alertas: usuarios sin finca, inactivos 30+ d√≠as, nunca logueados

### 2. FINCAS
- Listar con b√∫squeda y filtros
- Ver detalle con potreros asociados
- Crear finca (con geometr√≠a WKT o PostGIS)
- Editar finca
- Cambiar estado (ACTIVA/INACTIVA)
- Asociar/desasociar usuarios con roles
- Alertas: fincas sin potreros, sin actividad reciente

### 3. POTREROS
- Listar por finca
- Crear potrero dentro de finca
- Editar potrero
- Activar/Desactivar
- Ver registros ganaderos del potrero

### 4. REGISTROS GANADEROS
- Listar por potrero
- Crear nuevo registro
- Editar registro
- Ver historial

### 5. DEMOGRAF√çA
- Agregar/editar datos demogr√°ficos de usuario
- Estad√≠sticas agregadas

## Restricciones T√©cnicas CR√çTICAS

### JavaScript
- **NUNCA usar localStorage ni sessionStorage** (no funciona en todos los contextos)
- Usar SOLO variables en memoria o cookies para state
- M√≥dulos ES6 con import/export
- Fetch API para AJAX (sin jQuery)
- Compatible con navegadores modernos sin transpilaci√≥n

### Rutas y URLs
- **Rutas completamente relativas**: Usar `api` no `/api` ni `./api`
- **APIs en public/**: Colocar archivos PHP de API en `public/api/` para acceso directo
- **URLs aut√≥nomas**: El sistema debe funcionar desde cualquier dominio/ruta sin cambios
- **Construcci√≥n de URLs**: Siempre verificar barras `/` entre baseURL y endpoint
- **Debug de URLs**: Incluir `console.log` para verificar URLs construidas

### PHP Backend
Clases php usando un ORM Base de Datos PostgreSQL

NUNCA crear, modificar o eliminar tablas
NUNCA hacer DROP, ALTER TABLE, CREATE TABLE
Solo SELECT, INSERT, UPDATE (no DELETE f√≠sico) Usar soft delete cambiando campo "activo" o "estado" Frontend

Mobile-first OBLIGATORIO
Sin frameworks (React, Vue, Angular)
Sin bundlers (Webpack, Vite)
CSS vanilla o tiwlind  
Componentes modulares con clases ES6  Apache Hosting

Todo debe correr en Apache convencional
.htaccess para rewrite rules
PHP 8.1+ disponible
Extensi√≥n PostgreSQL habilitada (pdo_pgsql)
mod_rewrite habilitado no usaremos slim Framework sino  clases PHP puras + PDO (que es como un ORM ligero).

## DISE√ëO VISUAL - iOS/Apple Style + Telegan Brand

### Principios de Dise√±o
- **Mobile-first iOS style**: Inspirado en iOS Human Interface Guidelines
- **Minimalismo**: Espacios en blanco generosos, tipograf√≠a clara
- **Interacciones suaves**: Transiciones y animaciones sutiles
- **Accesibilidad**: Contraste WCAG AA, touch targets 44x44px m√≠nimo

### Colores Telegan (Ya definidos)
/* ===================================
   CSS Variables - Theme System
   =================================== */
:root {
  /* Light Theme */
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-card: #ffffff;
  --text-primary: #1a1a1a;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  --border-color: rgba(0, 0, 0, 0.08);
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);

  /* Telegan Brand Colors */
  --accent-primary: #6dbe45; /* Verde menta */
  --accent-secondary: #4da1d9; /* Azul cielo */
  --accent-tertiary: #a4d65e; /* Verde lima */
  --accent-warm: #ffd166; /* Amarillo suave */

  /* Gradients */
  --gradient-primary: linear-gradient(135deg, #6dbe45 0%, #4da1d9 100%);
  --gradient-accent: linear-gradient(90deg, #6dbe45 0%, #4da1d9 50%, #a4d65e 100%);
}

[data-theme="dark"] {
  --bg-primary: #0a0a0a;
  --bg-secondary: #141414;
  --bg-card: #1a1a1a;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --text-tertiary: #71717a;
  --border-color: rgba(255, 255, 255, 0.08);
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
}

/* ===================================
   Base Styles
   =================================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  transition: background-color 0.3s ease, color 0.3s ease;
  overflow-x: hidden;
}

## DASHBOARD PRINCIPAL - Estructura y Funcionalidad Inicial

### Layout Principal (Desktop + Mobile)

#### Estructura General‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Header (Top Bar con logo y usuario)   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ          ‚îÇ                              ‚îÇ
‚îÇ  Sidebar ‚îÇ   Main Content Area          ‚îÇ
‚îÇ  (Menu)  ‚îÇ   (Dashboard widgets/vistas) ‚îÇ
‚îÇ          ‚îÇ                              ‚îÇ
‚îÇ          ‚îÇ                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ     Bottom Nav (Mobile only)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

#### Componentes del Layout

**1. Top Header**
- Logo Telegan (izquierda)
- T√≠tulo de secci√≥n actual (centro en mobile)
- Avatar + nombre del admin + dropdown (derecha)
- Toggle men√∫ hamburguesa (mobile)
- Notificaciones badge (futuro)

**2. Sidebar (Desktop) / Drawer (Mobile)**

## SEGURIDAD Y AUTENTICACI√ìN - Mejores Pr√°cticas

### Principios de Seguridad CR√çTICOS
- **NUNCA hardcodear credenciales** en el c√≥digo fuente
- **Siempre usar variables de entorno** para datos sensibles
- **Validar TODOS los inputs** del usuario antes de procesar
- **Sanitizar TODAS las salidas** para prevenir XSS
- **Usar consultas preparadas** SIEMPRE (PDO prepare/execute)
- **Implementar autenticaci√≥n** en todos los endpoints sensibles
- **Validar origen de requests** (dominio autorizado)
- **Manejar sesiones de forma segura** con tokens √∫nicos

### Sistema de Autenticaci√≥n
- **Token de Aplicaci√≥n**: Cada instalaci√≥n tiene un token √∫nico
- **Validaci√≥n de Dominio**: APIs solo responden desde dominio autorizado
- **Sesiones de Usuario**: Sistema h√≠brido (token app + sesi√≥n usuario)
- **Roles y Permisos**: SUPER_ADMIN, TECNICO, ADMIN_FINCA
- **Confirmaci√≥n por Email**: Registro con PIN/confirmaci√≥n obligatoria

### Validaci√≥n de Datos
```php
// SIEMPRE validar inputs
function validateInput($input, $type = 'string', $maxLength = 255) {
    if (empty($input)) return false;
    
    switch ($type) {
        case 'email':
            return filter_var($input, FILTER_VALIDATE_EMAIL) !== false;
        case 'numeric':
            return is_numeric($input) && $input > 0;
        case 'string':
        default:
            $cleaned = trim($input);
            return strlen($cleaned) <= $maxLength && 
                   preg_match('/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë0-9\s\-_\.@]+$/', $cleaned);
    }
}

// SIEMPRE sanitizar outputs
function sanitizeOutput($data) {
    if (is_array($data)) {
        return array_map('sanitizeOutput', $data);
    }
    return htmlspecialchars($data ?? '', ENT_QUOTES, 'UTF-8');
}
```

### Configuraci√≥n de Seguridad
```php
// Headers de seguridad OBLIGATORIOS
function setSecurityHeaders() {
    header('X-Frame-Options: DENY');
    header('X-Content-Type-Options: nosniff');
    header('X-XSS-Protection: 1; mode=block');
    header('Referrer-Policy: strict-origin-when-cross-origin');
    header("Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'");
}

// Validaci√≥n de dominio OBLIGATORIA
function validateDomain() {
    $allowedDomain = $_ENV['APP_DOMAIN'] ?? 'localhost';
    if ($_SERVER['HTTP_HOST'] !== $allowedDomain) {
        http_response_code(403);
        die('Access denied: Invalid domain');
    }
}
```

### Manejo de Base de Datos Seguro
- **NUNCA concatenar strings** en consultas SQL
- **Usar par√°metros preparados** SIEMPRE
- **Validar tipos de datos** antes de insertar
- **Usar transacciones** para operaciones cr√≠ticas
- **Log de errores** sin exponer informaci√≥n sensible

### Variables de Entorno Requeridas
```env
# Base de datos
DB_HOST=localhost
DB_PORT=5432
DB_NAME=telegan
DB_USER=usuario_seguro
DB_PASSWORD=password_muy_seguro

# Aplicaci√≥n
APP_DOMAIN=tu-dominio.com
APP_TOKEN=token_unico_por_instalacion
APP_ENV=production

# Email (para confirmaciones)
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=tu_email@telegan.com
MAIL_PASSWORD=tu_app_password
MAIL_ENCRYPTION=tls
```

### Archivos que NUNCA deben subirse a Git
```
.env
*.log
/vendor/
/node_modules/
/tmp/
/cache/
```

### Patrones de C√≥digo Seguro
- **Validar ‚Üí Sanitizar ‚Üí Procesar ‚Üí Responder**
- **Manejo de errores** sin exponer informaci√≥n interna
- **Logging de seguridad** para auditor√≠a
- **Rate limiting** para prevenir ataques de fuerza bruta
- **CORS configurado** correctamente

## M√ìDULO DE AUTENTICACI√ìN AUT√ìNOMO

### Arquitectura del Sistema de Auth
- **Aplicaci√≥n completamente separada** en directorio `/auth/`
- **Base de datos independiente** con tablas espec√≠ficas para usuarios del sistema
- **Sistema de seguridad robusto** con rate limiting y validaci√≥n
- **Comunicaci√≥n entre m√≥dulos** mediante tokens de aplicaci√≥n

### Estructura del M√≥dulo Auth
```
auth/
‚îú‚îÄ‚îÄ index.php              # Punto de entrada principal
‚îú‚îÄ‚îÄ login.php              # P√°gina de login
‚îú‚îÄ‚îÄ register.php           # P√°gina de registro
‚îú‚îÄ‚îÄ confirm.php            # P√°gina de confirmaci√≥n de email
‚îú‚îÄ‚îÄ forgot-password.php    # Recuperaci√≥n de contrase√±a
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ Database.php       # Conexi√≥n independiente
‚îÇ   ‚îú‚îÄ‚îÄ Security.php       # Seguridad robusta
‚îÇ   ‚îî‚îÄ‚îÄ Email.php          # Sistema de emails
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ css/auth.css       # Estilos iOS/Apple style
‚îÇ   ‚îî‚îÄ‚îÄ js/auth.js         # JavaScript moderno
‚îî‚îÄ‚îÄ templates/emails/      # Templates HTML de emails
```

### Tablas de Base de Datos Auth
```sql
-- Usuarios del sistema (administradores, t√©cnicos)
admin_users (
    id_admin, nombre_completo, email, password_hash,
    telefono, rol, activo, email_verificado,
    codigo_confirmacion, token_confirmacion, expiracion_confirmacion,
    intentos_login, bloqueado_hasta, created_by
)

-- Sesiones activas
admin_sessions (
    id_sesion, id_admin, token_sesion,
    ip_address, user_agent, fecha_expiracion, activa
)

-- Tokens de aplicaci√≥n (comunicaci√≥n entre m√≥dulos)
app_tokens (
    id_token, token_hash, nombre_aplicacion,
    dominio_autorizado, permisos, activo
)

-- Logs de seguridad
security_logs (
    id_log, id_admin, tipo_evento,
    ip_address, user_agent, detalles, severidad
)

-- Confirmaciones pendientes
pending_confirmations (
    id_confirmacion, email, codigo_confirmacion,
    token_confirmacion, tipo_confirmacion, fecha_expiracion
)
```

### Flujo de Autenticaci√≥n
```
1. Registro ‚Üí Validaci√≥n ‚Üí Email de confirmaci√≥n
2. Confirmaci√≥n ‚Üí C√≥digo de 6 d√≠gitos ‚Üí Activaci√≥n
3. Login ‚Üí Rate limiting ‚Üí Sesi√≥n segura
4. Recuperaci√≥n ‚Üí Email ‚Üí C√≥digo ‚Üí Nueva contrase√±a
```

### Caracter√≠sticas de Seguridad Auth
- **Rate limiting**: M√°ximo 10 intentos por hora por IP
- **Bloqueo temporal**: 15 minutos despu√©s de 5 intentos fallidos
- **Validaci√≥n robusta**: Todos los inputs validados en tiempo real
- **Sanitizaci√≥n completa**: XSS prevention en todas las salidas
- **Logging de seguridad**: Auditor√≠a completa de eventos
- **Sesiones seguras**: Tokens √∫nicos con expiraci√≥n
- **Hash Argon2ID**: Contrase√±as con algoritmo moderno

### Sistema de Emails
- **Usa mail() nativo** de PHP (sin dependencias externas)
- **Templates HTML modernos** con dise√±o responsive
- **Tipos de email**: Confirmaci√≥n, recuperaci√≥n, bienvenida
- **Configuraci√≥n flexible** en archivo .env
- **Fallback graceful** si falla el env√≠o

### Tema Claro/Oscuro
- **Detecci√≥n autom√°tica** de preferencia del sistema
- **Persistencia** en localStorage
- **Toggle manual** en todas las p√°ginas
- **Transiciones suaves** entre temas
- **Mobile-first** responsive design

### Roles y Permisos
```php
const ROLES = [
    'SUPER_ADMIN' => 1,    // Due√±os del proyecto
    'TECNICO' => 2,        // T√©cnicos que asisten ganaderos
    'ADMIN_FINCA' => 3     // Administradores de finca
];
```

### Integraci√≥n con Dashboard Principal
- **Redirecci√≥n autom√°tica** al dashboard despu√©s del login
- **Tokens de sesi√≥n** compartidos entre m√≥dulos
- **Validaci√≥n de dominio** para APIs
- **Middleware de autenticaci√≥n** para endpoints protegidos

### Scripts de Utilidad
```bash
# Crear usuario de prueba
php auth/create-test-user.php

# Debug de login
php auth/debug-login.php

# Probar emails
php auth/test-email.php

# Generar token de aplicaci√≥n
php generate-app-token.php
```

### Configuraci√≥n Requerida
```env
# Base de datos (compartida con m√≥dulo principal)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=telegan
DB_USER=usuario_seguro
DB_PASSWORD=password_muy_seguro

# Aplicaci√≥n
APP_DOMAIN=telegan.espacialhn.com
APP_TOKEN=token_generado_con_script
APP_ENV=production

# Email
MAIL_FROM_NAME="Telegan Admin"
MAIL_FROM_EMAIL=noreply@telegan.com
MAIL_REPLY_TO=support@telegan.com
```

### Mejores Pr√°cticas Auth
- **NUNCA exponer informaci√≥n sensible** en logs
- **SIEMPRE validar origen** de requests
- **USAR transacciones** para operaciones cr√≠ticas
- **IMPLEMENTAR timeout** en sesiones
- **LOGEAR eventos de seguridad** para auditor√≠a
- **SANITIZAR todos los inputs** antes de procesar
- **USAR headers de seguridad** en todas las respuestas

## SISTEMA DE SEGURIDAD GRADUAL IMPLEMENTADO

### Arquitectura de Seguridad Actual
- **Sistema h√≠brido**: Desarrollo flexible + Producci√≥n estricta
- **Tokens de aplicaci√≥n**: Validaci√≥n entre frontend y backend
- **Middleware gradual**: Activaci√≥n progresiva sin romper funcionalidad
- **Enmascaramiento preparado**: Ocultaci√≥n de endpoints para producci√≥n

### Componentes Implementados

#### 1. Sistema de Tokens de Aplicaci√≥n (`src/Config/AppToken.php`)
```php
// Genera hash basado en: timestamp + user_agent + secret + dominio
// Validaci√≥n temporal: m√°ximo 5 minutos de diferencia
// Bypass autom√°tico en desarrollo (APP_ENV=development)
```

#### 2. Middleware de Seguridad (`src/Middleware/SecurityMiddleware.php`)
```php
// Opciones de validaci√≥n:
SecurityMiddleware::publicApi();              // Solo logging
SecurityMiddleware::requireAppToken(false);   // Token flexible (desarrollo)
SecurityMiddleware::requireAuth(true);        // Autenticaci√≥n completa (producci√≥n)
```

#### 3. Frontend con Tokens Autom√°ticos (`public/js/ApiClient.js`)
```javascript
// Env√≠a autom√°ticamente:
headers: {
    'X-App-Token': 'hash_generado',
    'X-App-Timestamp': 'timestamp'
}
```

#### 4. Enmascaramiento de APIs (`src/Services/ApiMasking.php`)
```php
// Desarrollo: 'dashboard-data' ‚Üí 'dashboard.php'
// Producci√≥n: 'dashboard-data' ‚Üí 'data_a1b2c3d4.php'
```

### Estado Actual de Seguridad

| Aspecto | Estado | Nivel de Riesgo |
|---------|--------|-----------------|
| Credenciales | ‚úÖ En .env | BAJO |
| CORS | ‚ö†Ô∏è Abierto (desarrollo) | MEDIO |
| Autenticaci√≥n | üîÑ Preparado | BAJO |
| Tokens | ‚úÖ Implementados | BAJO |
| Enmascaramiento | üîÑ Preparado | BAJO |
| Headers Seguridad | ‚úÖ Implementados | BAJO |

### Implementaci√≥n en APIs

#### Patr√≥n Est√°ndar para Nuevas APIs
```php
<?php
// Incluir middleware de seguridad
require_once '../../src/Middleware/SecurityMiddleware.php';

// Inicializar middleware
SecurityMiddleware::init();

// Configurar headers de respuesta
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *'); // Mantener abierto durante desarrollo

// Manejar preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

// VALIDACI√ìN GRADUAL DE SEGURIDAD
// Opci√≥n 1: Solo logging (desarrollo actual)
SecurityMiddleware::publicApi();

// Opci√≥n 2: Token de aplicaci√≥n (cuando est√© listo)
// SecurityMiddleware::requireAppToken(false);

// Opci√≥n 3: Autenticaci√≥n completa (producci√≥n)
// SecurityMiddleware::requireAuth(true);

// Tu l√≥gica de API aqu√≠...
?>
```

### Configuraci√≥n de Desarrollo

#### Variables de Entorno (.env)
```env
# Modo de desarrollo
APP_ENV=development
APP_DOMAIN=localhost
APP_SECRET=telegan_default_secret
APP_TOKEN=generado_automaticamente

# Base de datos (credenciales seguras)
DB_HOST=157.245.241.220
DB_PORT=5432
DB_NAME=telegan
DB_USER=telegan
DB_PASSWORD=telegan
```

#### Script de Configuraci√≥n
```bash
# Ejecutar una vez para configurar seguridad
php scripts/setup-security.php
```

### Plan de Migraci√≥n a Producci√≥n

#### Fase 1: Preparaci√≥n (ACTUAL)
- ‚úÖ APIs funcionan sin validaci√≥n
- ‚úÖ Tokens se generan y env√≠an autom√°ticamente
- ‚úÖ Logs de peticiones habilitados
- ‚úÖ Sistema preparado para validaci√≥n

#### Fase 2: Activaci√≥n Gradual (CUANDO EST√âS LISTO)
```php
// En cada API, cambiar de:
SecurityMiddleware::publicApi();

// A:
SecurityMiddleware::requireAppToken(false); // false = flexible en desarrollo
```

#### Fase 3: Producci√≥n (CUANDO EST√â LISTO)
```env
# Cambiar en .env:
APP_ENV=production
APP_DOMAIN=tu-dominio-real.com
```

```php
// En APIs, usar validaci√≥n estricta:
SecurityMiddleware::requireAuth(true);
```

#### Fase 4: Enmascaramiento (OPCIONAL)
```php
// Activar enmascaramiento de endpoints
ApiMasking::generateMaskedFiles();
```

### Checklist de Migraci√≥n a Producci√≥n

#### Antes de Cambiar a Producci√≥n
- [ ] Configurar APP_DOMAIN real
- [ ] Cambiar APP_ENV=production
- [ ] Revisar logs de seguridad
- [ ] Probar todas las APIs con tokens
- [ ] Configurar CORS restrictivo
- [ ] Backup de base de datos

#### Durante el Cambio
- [ ] Activar validaci√≥n gradualmente
- [ ] Monitorear logs de errores
- [ ] Verificar funcionamiento del frontend
- [ ] Probar acceso directo a APIs (debe fallar)

#### Despu√©s del Cambio
- [ ] Verificar que APIs no funcionan sin tokens
- [ ] Confirmar que frontend sigue funcionando
- [ ] Revisar logs de seguridad
- [ ] Activar enmascaramiento si se desea

### Comandos de Utilidad

#### Configuraci√≥n Inicial
```bash
php scripts/setup-security.php
```

#### Verificar Logs
```bash
tail -f logs/security.log
```

#### Probar API con Token
```bash
curl -H "X-App-Token: hash" \
     -H "X-App-Timestamp: timestamp" \
     http://localhost/api/dashboard.php
```

### Respuesta a Vulnerabilidades Comunes

#### "Si un usuario mira en consola las APIs, no podr√° ejecutarlas"

**Estado Actual (Desarrollo):**
- üîç APIs visibles en consola
- üîç APIs ejecutables sin validaci√≥n
- üîç Tokens enviados autom√°ticamente

**Estado Futuro (Producci√≥n):**
- ‚úÖ APIs protegidas con validaci√≥n
- ‚ùå Sin token v√°lido = acceso denegado
- ‚úÖ Endpoints enmascarados (opcional)

#### Protecci√≥n Implementada
1. **Tokens de aplicaci√≥n**: Hash √∫nico por sesi√≥n
2. **Validaci√≥n temporal**: M√°ximo 5 minutos
3. **Validaci√≥n de dominio**: Solo desde dominio autorizado
4. **Rate limiting**: Prevenci√≥n de ataques de fuerza bruta
5. **Headers de seguridad**: Protecci√≥n contra XSS, clickjacking
6. **Logs de auditor√≠a**: Registro de todas las peticiones

### Mejores Pr√°cticas de Seguridad

#### Desarrollo
- **Mantener APP_ENV=development** durante desarrollo
- **Revisar logs regularmente** para detectar patrones sospechosos
- **Probar APIs sin tokens** para verificar que fallan
- **Validar inputs** en todas las APIs

#### Producci√≥n
- **Cambiar APP_ENV=production** solo cuando est√© listo
- **Configurar dominio real** en APP_DOMAIN
- **Activar validaci√≥n estricta** en todas las APIs
- **Monitorear logs de seguridad** constantemente
- **Mantener backups** de configuraci√≥n y base de datos

### Archivos Cr√≠ticos de Seguridad
```
src/Config/AppToken.php           # Sistema de tokens
src/Middleware/SecurityMiddleware.php # Middleware de validaci√≥n
src/Services/ApiMasking.php       # Enmascaramiento de endpoints
scripts/setup-security.php        # Configuraci√≥n autom√°tica
.env                              # Variables de entorno (NUNCA subir a Git)
```

### Notas Importantes
- **El sistema NO rompe funcionalidad actual** durante desarrollo
- **La migraci√≥n es gradual** - puedes activar cuando quieras
- **Los tokens son autom√°ticos** - el frontend los env√≠a sin cambios
- **El enmascaramiento es opcional** - para m√°xima seguridad
- **Los logs son cr√≠ticos** - para auditor√≠a y debugging